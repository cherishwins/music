#!/usr/bin/env npx tsx
/**
 * Deploy TigerPayments Contract
 *
 * Deploys to Base Sepolia (testnet) or Base Mainnet
 *
 * Usage:
 *   PRIVATE_KEY=0x... npx tsx scripts/deploy-tiger-payments.ts
 *   PRIVATE_KEY=0x... MAINNET=true npx tsx scripts/deploy-tiger-payments.ts
 */

import {
  createWalletClient,
  createPublicClient,
  http,
  encodeFunctionData,
  parseAbi,
  formatUnits,
} from "viem";
import { baseSepolia, base } from "viem/chains";
import { privateKeyToAccount } from "viem/accounts";

// Contract bytecode - compiled with solc 0.8.33 from TigerPayments.sol
const TIGER_PAYMENTS_BYTECODE = "0x608060405234801561000f575f5ffd5b5060405161120338038061120383398181016040528101906100319190610155565b8160025f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550805f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff1602179055503360015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050610193565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610124826100fb565b9050919050565b6101348161011a565b811461013e575f5ffd5b50565b5f8151905061014f8161012b565b92915050565b5f5f6040838503121561016b5761016a6100f7565b5b5f61017885828601610141565b925050602061018985828601610141565b9150509250929050565b611063806101a05f395ff3fe608060405234801561000f575f5ffd5b506004361061009c575f3560e01c8063d0ee4de011610064578063d0ee4de014610149578063e66eefc814610165578063f0f4426014610198578063f2fde38b146101b4578063feef6640146101d05761009c565b80630716326d146100a05780633e413bee146100d357806349949830146100f157806361d027b31461010d5780638da5cb5b1461012b575b5f5ffd5b6100ba60048036038101906100b59190610aba565b610200565b6040516100ca9493929190610b56565b60405180910390f35b6100db610257565b6040516100e89190610bf4565b60405180910390f35b61010b60048036038101906101069190610aba565b61027c565b005b610115610468565b6040516101229190610c0d565b60405180910390f35b61013361048c565b6040516101409190610c0d565b60405180910390f35b610163600480360381019061015e9190610c50565b6104b1565b005b61017f600480360381019061017a9190610aba565b6107ae565b60405161018f9493929190610b56565b60405180910390f35b6101b260048036038101906101ad9190610cb8565b610876565b005b6101ce60048036038101906101c99190610cb8565b610947565b005b6101ea60048036038101906101e59190610aba565b610a19565b6040516101f79190610ce3565b60405180910390f35b6003602052805f5260405f205f91509050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806001015490806002015490806003015f9054906101000a900460ff16905084565b60025f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461030b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161030290610d56565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff1660035f8381526020019081526020015f205f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16036103ab576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103a290610dbe565b60405180910390fd5b60035f8281526020019081526020015f206003015f9054906101000a900460ff161561040c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161040390610e26565b60405180910390fd5b600160035f8381526020019081526020015f206003015f6101000a81548160ff021916908315150217905550807f1a353683a28715629a831c24798028481eb73af104bc8d2c2f5407f470fa837660405160405180910390a250565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f81116104f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104ea90610e8e565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff1660035f8481526020019081526020015f205f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610593576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161058a90610ef6565b60405180910390fd5b5f60025f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd335f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16856040518463ffffffff1660e01b815260040161061293929190610f14565b6020604051808303815f875af115801561062e573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106529190610f73565b905080610694576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161068b90610fe8565b60405180910390fd5b60405180608001604052803373ffffffffffffffffffffffffffffffffffffffff1681526020018381526020014281526020015f151581525060035f8581526020019081526020015f205f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010155604082015181600201556060820151816003015f6101000a81548160ff0219169083151502179055509050503373ffffffffffffffffffffffffffffffffffffffff16837fb84982556d7cb15bbbde57cf4d92e7e35098afd173f6b52783916ffd21f49fab84426040516107a1929190611006565b60405180910390a3505050565b5f5f5f5f5f60035f8781526020019081526020015f206040518060800160405290815f82015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815260200160028201548152602001600382015f9054906101000a900460ff1615151515815250509050805f01518160200151826040015183606001519450945094509450509193509193565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610905576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108fc90610d56565b60405180910390fd5b805f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146109d6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109cd90610d56565b60405180910390fd5b8060015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b5f5f73ffffffffffffffffffffffffffffffffffffffff1660035f8481526020019081526020015f205f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614159050919050565b5f5ffd5b5f819050919050565b610a9981610a87565b8114610aa3575f5ffd5b50565b5f81359050610ab481610a90565b92915050565b5f60208284031215610acf57610ace610a83565b5b5f610adc84828501610aa6565b91505092915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610b0e82610ae5565b9050919050565b610b1e81610b04565b82525050565b5f819050919050565b610b3681610b24565b82525050565b5f8115159050919050565b610b5081610b3c565b82525050565b5f608082019050610b695f830187610b15565b610b766020830186610b2d565b610b836040830185610b2d565b610b906060830184610b47565b95945050505050565b5f819050919050565b5f610bbc610bb7610bb284610ae5565b610b99565b610ae5565b9050919050565b5f610bcd82610ba2565b9050919050565b5f610bde82610bc3565b9050919050565b610bee81610bd4565b82525050565b5f602082019050610c075f830184610be5565b92915050565b5f602082019050610c205f830184610b15565b92915050565b610c2f81610b24565b8114610c39575f5ffd5b50565b5f81359050610c4a81610c26565b92915050565b5f5f60408385031215610c6657610c65610a83565b5b5f610c7385828601610aa6565b9250506020610c8485828601610c3c565b9150509250929050565b610c9781610b04565b8114610ca1575f5ffd5b50565b5f81359050610cb281610c8e565b92915050565b5f60208284031215610ccd57610ccc610a83565b5b5f610cda84828501610ca4565b91505092915050565b5f602082019050610cf65f830184610b47565b92915050565b5f82825260208201905092915050565b7f4e6f74206f776e657200000000000000000000000000000000000000000000005f82015250565b5f610d40600983610cfc565b9150610d4b82610d0c565b602082019050919050565b5f6020820190508181035f830152610d6d81610d34565b9050919050565b7f496e766f696365206e6f7420666f756e640000000000000000000000000000005f82015250565b5f610da8601183610cfc565b9150610db382610d74565b602082019050919050565b5f6020820190508181035f830152610dd581610d9c565b9050919050565b7f416c72656164792066756c66696c6c65640000000000000000000000000000005f82015250565b5f610e10601183610cfc565b9150610e1b82610ddc565b602082019050919050565b5f6020820190508181035f830152610e3d81610e04565b9050919050565b7f416d6f756e74206d757374206265203e203000000000000000000000000000005f82015250565b5f610e78601283610cfc565b9150610e8382610e44565b602082019050919050565b5f6020820190508181035f830152610ea581610e6c565b9050919050565b7f496e766f69636520616c726561647920706169640000000000000000000000005f82015250565b5f610ee0601483610cfc565b9150610eeb82610eac565b602082019050919050565b5f6020820190508181035f830152610f0d81610ed4565b9050919050565b5f606082019050610f275f830186610b15565b610f346020830185610b15565b610f416040830184610b2d565b949350505050565b610f5281610b3c565b8114610f5c575f5ffd5b50565b5f81519050610f6d81610f49565b92915050565b5f60208284031215610f8888610f87610a83565b5b5f610f9584828501610f5f565b91505092915050565b7f55534443207472616e73666572206661696c65640000000000000000000000005f82015250565b5f610fd2601483610cfc565b9150610fdd82610f9e565b602082019050919050565b5f6020820190508181035f830152610fff81610fc6565b9050919050565b5f6040820190506110195f830185610b2d565b6110266020830184610b2d565b939250505056fea264697066735822122061bb59e29e66c9293a789da00389e4d4c191960c7f8fd3eb5246df7cd545444a64736f6c63430008210033" as `0x${string}`;

// Constructor ABI
const CONSTRUCTOR_ABI = parseAbi([
  "constructor(address _usdc, address _treasury)",
]);

// Network configurations
const NETWORKS = {
  testnet: {
    chain: baseSepolia,
    rpc: "https://sepolia.base.org",
    usdc: "0x036CbD53842c5426634e7929541eC2318f3dCF7e", // Base Sepolia USDC
    explorer: "https://sepolia.basescan.org",
  },
  mainnet: {
    chain: base,
    rpc: "https://mainnet.base.org",
    usdc: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // Base Mainnet USDC
    explorer: "https://basescan.org",
  },
};

async function main() {
  const privateKey = process.env.PRIVATE_KEY as `0x${string}`;
  if (!privateKey) {
    console.error("Error: PRIVATE_KEY environment variable required");
    console.log("\nUsage:");
    console.log("  PRIVATE_KEY=0x... npx tsx scripts/deploy-tiger-payments.ts");
    process.exit(1);
  }

  const isMainnet = process.env.MAINNET === "true";
  const network = isMainnet ? NETWORKS.mainnet : NETWORKS.testnet;

  console.log("\nüêØ TigerPayments Deployment");
  console.log("=".repeat(50));
  console.log(`Network: ${isMainnet ? "Base Mainnet" : "Base Sepolia (testnet)"}`);
  console.log(`USDC: ${network.usdc}`);
  console.log("");

  // Create account from private key
  const account = privateKeyToAccount(privateKey);
  console.log(`Deployer: ${account.address}`);

  // Create clients
  const publicClient = createPublicClient({
    chain: network.chain,
    transport: http(network.rpc),
  });

  const walletClient = createWalletClient({
    account,
    chain: network.chain,
    transport: http(network.rpc),
  });

  // Check deployer balance
  const balance = await publicClient.getBalance({ address: account.address });
  console.log(`Balance: ${formatUnits(balance, 18)} ETH`);

  if (balance < BigInt(1e15)) {
    console.error("\n‚ùå Insufficient ETH for deployment gas");
    console.log(`Get testnet ETH: https://www.coinbase.com/faucets/base-sepolia`);
    process.exit(1);
  }

  // Treasury = deployer by default (you control it!)
  const treasury = account.address;
  console.log(`Treasury: ${treasury}`);
  console.log("");

  console.log("üìú Deploying TigerPayments contract...");

  try {
    // Encode constructor arguments (usdc, treasury)
    const constructorArgs = [network.usdc, treasury] as const;

    // ABI for the contract
    const abi = [
      {
        type: "constructor",
        inputs: [
          { name: "_usdc", type: "address" },
          { name: "_treasury", type: "address" },
        ],
      },
    ] as const;

    // Deploy using deployContract with proper ABI
    const hash = await walletClient.deployContract({
      abi,
      bytecode: TIGER_PAYMENTS_BYTECODE,
      args: constructorArgs,
    });

    console.log(`Transaction: ${hash}`);
    console.log("Waiting for confirmation...");

    const receipt = await publicClient.waitForTransactionReceipt({ hash });

    if (receipt.status === "success" && receipt.contractAddress) {
      console.log("\nüéâ CONTRACT DEPLOYED!");
      console.log(`Address: ${receipt.contractAddress}`);
      console.log(`Explorer: ${network.explorer}/address/${receipt.contractAddress}`);
      console.log("");
      console.log("Add to .env:");
      console.log(`TIGER_PAYMENTS_ADDRESS=${receipt.contractAddress}`);
      console.log(`NEXT_PUBLIC_TIGER_PAYMENTS_ADDRESS=${receipt.contractAddress}`);
    } else {
      console.error("‚ùå Deployment failed");
      process.exit(1);
    }
  } catch (error) {
    console.error("Deployment error:", error);
    process.exit(1);
  }
}

main().catch(console.error);
